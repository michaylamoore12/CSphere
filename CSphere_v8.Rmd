---
title: "CSphere"
author: "Michayla Moore"
date: "2024-08-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Install required packages if you don't have them
#install.packages("Matrix")
#install.packages("Seurat")  # or install BiocManager::install("SingleCellExperiment")

# Load the packages
library(Matrix)
library(Seurat)
library(GEOquery)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(dplyr)
library(patchwork)
library(writexl)
library(tibble)
```

```{r}
# Load the GEO dataset
gse <- getGEO("GSE149699", GSEMatrix = TRUE)
```


```{r}
# Raw data
# Download supplementary files for GSE149699
getGEOSuppFiles("GSE149699")

# Unzip files (if needed)
unzip("GSE149699_RAW.zip", exdir = "GSE149699_files")
```

```{r}
# List all the zipped files in the directory
zip_files <- list.files("GSE149699_files", pattern = "\\.gz$", full.names = TRUE)
# List all .gz files
gz_files <- list.files("GSE149699_files", pattern = "\\.gz$", full.names = TRUE)

for (gz_file in gz_files) {
  sample_name <- tools::file_path_sans_ext(basename(gz_file))
  target_dir <- paste0("GSE149699_files/", sample_name)
  
  # Create a directory for the sample if it doesn't exist
  if (!dir.exists(target_dir)) {
    dir.create(target_dir, recursive = TRUE)
  }
  
  # Define the output file path
  output_file <- paste0(target_dir, "/", tools::file_path_sans_ext(basename(gz_file)))
  
  # Unzip the .gz file into the target directory
  tryCatch({
    gunzip(gz_file, destname = output_file, overwrite = TRUE)
  }, error = function(e) {
    message("Error unzipping file: ", gz_file, "\n", e)
  })
}

```

```{r}
# Get all file names
file_names <- list.files("GSE149699_files", full.names = TRUE)

# Extract unique sample identifiers
sample_ids <- unique(gsub("_.*", "", basename(file_names)))

# Print sample IDs to verify
print(sample_ids)

```

```{r}
# Define file paths for each sample
EC_barcodes <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509138_EC_barcodes.tsv"
EC_features <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509138_EC_features.tsv"
EC_matrix <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509138_EC_matrix.mtx"

CF_barcodes <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509139_CF_barcodes.tsv"
CF_features <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509139_CF_features.tsv"
CF_matrix <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509139_CF_matrix.mtx"

SMC_barcodes <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509140_SMC_barcodes.tsv"
SMC_features <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509140_SMC_features.tsv"
SMC_matrix <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509140_SMC_matrix.mtx"

Ad_barcodes <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509141_adult_barcodes.tsv"
Ad_features <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509141_adult_features.tsv"
Ad_matrix <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509141_adult_matrix.mtx"

Neo_barcodes <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509142_neonatal_barcodes.tsv"
Neo_features <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509142_neonatal_features.tsv"
Neo_matrix <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/GSM4509142_neonatal_matrix.mtx"

# Load the data for sample 1
barcodesEC <- read.table(EC_barcodes, header = FALSE, stringsAsFactors = FALSE)[[1]]
featuresEC <- read.table(EC_features, header = FALSE, stringsAsFactors = FALSE)
matrixEC <- readMM(EC_matrix)

# Create Seurat object for sample 1
seurat_sampleEC <- CreateSeuratObject(counts = matrixEC, assay = "RNA", project = "EC")
rownames(seurat_sampleEC) <- featuresEC$V2
colnames(seurat_sampleEC) <- barcodesEC

# Load the data for sample 1
barcodesCF <- read.table(CF_barcodes, header = FALSE, stringsAsFactors = FALSE)[[1]]
featuresCF <- read.table(CF_features, header = FALSE, stringsAsFactors = FALSE)
matrixCF <- readMM(CF_matrix)

# Create Seurat object for sample 2
seurat_sampleCF <- CreateSeuratObject(counts = matrixCF, assay = "RNA", project = "CF")
rownames(seurat_sampleCF) <- featuresCF$V2
colnames(seurat_sampleCF) <- barcodesCF

# Load the data for sample 3
barcodesSMC <- read.table(SMC_barcodes, header = FALSE, stringsAsFactors = FALSE)[[1]]
featuresSMC <- read.table(SMC_features, header = FALSE, stringsAsFactors = FALSE)
matrixSMC <- readMM(SMC_matrix)

# Create Seurat object for sample 4
seurat_sampleSMC <- CreateSeuratObject(counts = matrixSMC, assay = "RNA", project = "SMC")
rownames(seurat_sampleSMC) <- featuresSMC$V2
colnames(seurat_sampleSMC) <- barcodesSMC

# Load the data for sample 1
barcodesAd <- read.table(Ad_barcodes, header = FALSE, stringsAsFactors = FALSE)[[1]]
featuresAd <- read.table(Ad_features, header = FALSE, stringsAsFactors = FALSE)
matrixAd <- readMM(Ad_matrix)

# Create Seurat object for sample 1
seurat_sampleAd <- CreateSeuratObject(counts = matrixAd, assay = "RNA", project = "Ad")
rownames(seurat_sampleAd) <- featuresAd$V2
colnames(seurat_sampleAd) <- barcodesAd

# Load the data for sample 1
barcodesNeo <- read.table(Neo_barcodes, header = FALSE, stringsAsFactors = FALSE)[[1]]
featuresNeo <- read.table(Neo_features, header = FALSE, stringsAsFactors = FALSE)
matrixNeo <- readMM(Neo_matrix)

# Create Seurat object for sample 1
seurat_sampleNeo <- CreateSeuratObject(counts = matrixNeo, assay = "RNA", project = "Neo")
rownames(seurat_sampleNeo) <- featuresNeo$V2
colnames(seurat_sampleNeo) <- barcodesNeo

```


```{r}
seurat_sampleEC$orig.ident <- "EC"
seurat_sampleCF$orig.ident <- "CF"
seurat_sampleSMC$orig.ident <- "SMC"
seurat_sampleAd$orig.ident <- "AdultCDC"
seurat_sampleNeo$orig.ident <- "NeonatalCDC"

# Identify duplicate gene names
duplicated_genes <- rownames(seurat_sampleEC)[duplicated(rownames(seurat_sampleEC))]

# Print duplicated genes to confirm
cat("Duplicate genes found:\n", unique(duplicated_genes), "\n")

# Identify rows to remove (those with duplicate names)
dup_indices <- which(duplicated(rownames(seurat_sampleEC)) | duplicated(rownames(seurat_sampleEC), fromLast = TRUE))

# Remove duplicate rows
seurat_sampleEC_clean <- seurat_sampleEC[-dup_indices, ]

# Verify removal
remaining_duplicates <- rownames(seurat_sampleEC_clean)[duplicated(rownames(seurat_sampleEC_clean))]
cat("Remaining duplicate genes (if any):\n", unique(remaining_duplicates), "\n")

# Replace the original object with the cleaned one
seurat_sampleEC <- seurat_sampleEC_clean

# Normalize each Seurat object
seurat_sampleEC <- NormalizeData(seurat_sampleEC)

#CF
# Identify duplicate gene names
duplicated_genesCF <- rownames(seurat_sampleCF)[duplicated(rownames(seurat_sampleCF))]

# Print duplicated genes to confirm
cat("Duplicate genes found:\n", unique(duplicated_genesCF), "\n")

# Identify rows to remove (those with duplicate names)
dup_indicesCF <- which(duplicated(rownames(seurat_sampleCF)) | duplicated(rownames(seurat_sampleCF), fromLast = TRUE))

# Remove duplicate rows
seurat_sampleCF_clean <- seurat_sampleCF[-dup_indicesCF, ]

# Verify removal
remaining_duplicatesCF <- rownames(seurat_sampleCF_clean)[duplicated(rownames(seurat_sampleCF_clean))]
cat("Remaining duplicate genes (if any):\n", unique(remaining_duplicatesCF), "\n")

# Replace the original object with the cleaned one
seurat_sampleCF <- seurat_sampleCF_clean

# Normalize each Seurat object
seurat_sampleCF <- NormalizeData(seurat_sampleCF)

# Function to remove duplicate gene names from a Seurat object
clean_and_normalize <- function(seurat_object) {
  # Identify duplicate gene names
  duplicated_genes <- rownames(seurat_object)[duplicated(rownames(seurat_object))]
  
  # Print duplicated genes to confirm
  cat("Duplicate genes found:\n", unique(duplicated_genes), "\n")
  
  # Identify rows to remove (those with duplicate names)
  dup_indices <- which(duplicated(rownames(seurat_object)) | duplicated(rownames(seurat_object), fromLast = TRUE))
  
  # Remove duplicate rows
  seurat_object_clean <- seurat_object[-dup_indices, ]
  
  # Verify removal
  remaining_duplicates <- rownames(seurat_object_clean)[duplicated(rownames(seurat_object_clean))]
  cat("Remaining duplicate genes (if any):\n", unique(remaining_duplicates), "\n")
  
  # Replace the original object with the cleaned one
  seurat_object <- seurat_object_clean
  
  # Normalize the data
  seurat_object <- NormalizeData(seurat_object)
  
  return(seurat_object)
}

# Apply the function to each Seurat object
seurat_sampleCF <- clean_and_normalize(seurat_sampleCF)
seurat_sampleSMC <- clean_and_normalize(seurat_sampleSMC)
seurat_sampleAd <- clean_and_normalize(seurat_sampleAd)
seurat_sampleNeo <- clean_and_normalize(seurat_sampleNeo)


seurat_sampleCF <- NormalizeData(seurat_sampleCF)
seurat_sampleSMC <- NormalizeData(seurat_sampleSMC)
seurat_sampleAd <- NormalizeData(seurat_sampleAd)
seurat_sampleNeo <- NormalizeData(seurat_sampleNeo)
```

```{r}
seurat_sampleAd <- NormalizeData(seurat_sampleAd) %>% FindVariableFeatures() %>% ScaleData()
seurat_sampleNeo <- NormalizeData(seurat_sampleNeo) %>% FindVariableFeatures() %>% ScaleData()
seurat_sampleEC <- NormalizeData(seurat_sampleEC) %>% FindVariableFeatures() %>% ScaleData()
seurat_sampleSMC <- NormalizeData(seurat_sampleSMC) %>% FindVariableFeatures() %>% ScaleData()
seurat_sampleCF <- NormalizeData(seurat_sampleCF) %>% FindVariableFeatures() %>% ScaleData()
```

```{r}
seurat_objects <- list(seurat_sampleAd, seurat_sampleCF, seurat_sampleEC, seurat_sampleNeo, seurat_sampleSMC)

# Ident integration features
features <- SelectIntegrationFeatures(object.list = seurat_objects)

common_features <- Reduce(intersect, lapply(seurat_objects, function(x) rownames(GetAssayData(x, assay = "RNA", slot = "counts"))))
seurat_objects <- lapply(seurat_objects, function(x) {
  x <- subset(x, features = common_features)
  return(x)
})

# Align
anchors <- FindIntegrationAnchors(object.list = seurat_objects, anchor.features = features)
```

```{r}
# integrate data
seurat_combined <- IntegrateData(anchorset = anchors)
```


```{r}
# Check available assays and their slots
Assays(seurat_combined)

# Plot histogram for number of features
hist(seurat_combined$nFeature_RNA, main = "Number of Features per Cell", xlab = "Number of Features", col = "lightblue", breaks = 50)

#High Mitochondrial Content: A high proportion of mitochondrial gene expression (e.g., greater than 5-10%) is usually a sign of unhealthy or dying cells.
# Find mitochondrial genes (assuming you're working with human data)
#seurat_combined[["percent.mt"]] <- PercentageFeatureSet(seurat_combined, pattern = "^MT-")

meta <- seurat_combined@meta.data

# Plot histogram for percentage of mitochondrial genes
#hist(seurat_combined$percent.mt, main = "Percentage of Mitochondrial Genes per Cell", xlab = "Percentage of Mitochondrial #Genes", col = "lightgreen", breaks = 50)
```


```{r}
#seurat_combined_filter <- subset(seurat_combined, subset = nFeature_RNA > 100 & nFeature_RNA < 2500 & percent.mt < 5)
seurat_combined_filter <- subset(seurat_combined, subset = nFeature_RNA > 100 & nFeature_RNA < 2500)

# Plot histogram for number of features
hist(seurat_combined_filter$nFeature_RNA, main = "Number of Features per Cell", xlab = "Number of Features", col = "lightblue", breaks = 50)

# Plot histogram for percentage of mitochondrial genes
#hist(seurat_combined_filter$percent.mt, main = "Percentage of Mitochondrial Genes per Cell", xlab = "Percentage of #Mitochondrial Genes", col = "lightgreen", breaks = 50)
```

```{r}
# Assuming counts.Ad, counts.CF, etc., are matrices
combined_counts <- cbind(seurat_combined@assays$RNA$counts.Ad, 
                         seurat_combined@assays$RNA$counts.CF, 
                         seurat_combined@assays$RNA$counts.SMC, 
                         seurat_combined@assays$RNA$counts.Neo, 
                         seurat_combined@assays$RNA$counts.EC)  # Add all your counts matrices here

# Create Seurat object with combined counts
seurat_combined <- CreateSeuratObject(counts = combined_counts)
```

```{r}
seurat_combined <- NormalizeData(seurat_combined)
seurat_combined <- FindVariableFeatures(seurat_combined)
seurat_combined <- ScaleData(seurat_combined)
seurat_combined <- RunPCA(seurat_combined)

print(seurat_combined[["pca"]])

# Recompute PCA
seurat_combined <- RunPCA(seurat_combined, npcs = 30)

# Print PCA summary
print(seurat_combined[["pca"]])
```


```{r}
seurat_combined <- FindNeighbors(seurat_combined, dims = 1:14)
seurat_combined <- FindClusters(seurat_combined)
```

```{r}
# Add or update metadata in seurat_combined
seurat_combined <- AddMetaData(seurat_combined, metadata = meta)

# View metadata
head(seurat_combined@meta.data)

#RUN UMAP
seurat_combined <- RunUMAP(seurat_combined, dims = 1:14)
DimPlot(seurat_combined, reduction = "umap", group.by = "orig.ident")

```

```{r}
# Define custom colors for your specific cell types including AdultCDC and NeonatalCDC
custom_colors <- c("CF" = "darkgreen", 
                   "EC" = "purple", 
                   "SMC" = "darkorange", 
                   "AdultCDC" = "blue", 
                   "NeonatalCDC" = "red")

#library(RColorBrewer)
#custom_colors <- brewer.pal(n = 5, name = "Dark2")

# Create UMAP plot with custom colors for specific cell types and CDC groups
DimPlot(seurat_combined, 
        reduction = "umap", 
        group.by = "orig.ident", 
        cols = custom_colors)

# Create UMAP plot with custom colors for specific cell types and CDC groups
DimPlot(seurat_combined, 
        reduction = "umap", 
        group.by = "orig.ident", 
        cols = custom_colors) +  # Adjust point size as needed
    theme(legend.position = c(0, 1),  # Set legend position to top left
          legend.justification = c("left", "top"))  # Adjust justification

# Create UMAP plot with custom colors for specific cell types and CDC groups
umap_plot <- DimPlot(seurat_combined, 
                      reduction = "umap", 
                      group.by = "orig.ident", 
                      cols = custom_colors) +  # Adjust point size
    theme(legend.position = c(0, 1),  # Set legend position to top left
          legend.justification = c("left", "top"))  # Adjust justification

# Save the plot as a PNG image with dimensions 5x5 inches
ggsave("umap_plot.png", plot = umap_plot, width = 5, height = 5, dpi = 1200)

umap_plot

```



```{r}
all_features <- rownames(seurat_combined[["RNA"]])
head(all_features)  # View the first few features
all_features_df <- as.data.frame(all_features)

any(all_features_df == "ANXA2")

FeaturePlot(seurat_combined,reduction = "umap",features="CXCL6",split.by="orig.ident")
```

```{r}

# Extract UMAP coordinates
umap_coords <- Embeddings(seurat_combined, reduction = "umap")

# Extract gene expression data and metadata
gene_data <- FetchData(seurat_combined, vars = c("NRDC", "orig.ident"))

# Combine UMAP coordinates with gene expression data
umap_data <- cbind(umap_coords, gene_data)

# View the first few rows of the combined data
head(umap_data)

#umap_data <- umap_data %>%
 # rename(CD73 = NT5E)

# Reshape the data to long format
umap_long <- melt(umap_data, id.vars = c("umap_1", "umap_2", "orig.ident"), 
                  measure.vars = c("NRDC"),
                  variable.name = "gene", value.name = "expression")

# View the first few rows of the reshaped data
head(umap_long)

# Use ggplot to create custom plots with different colors for each gene
ggplot(umap_long, aes(x = umap_1, y = umap_2, color = expression)) +
  geom_point() +
  facet_grid(gene ~ orig.ident) +  # Facet by gene and cell type
  scale_color_gradient(low = "lightgrey", high = "blue") +
  theme_minimal() +
  ggtitle("Gene Expression on UMAP")


```

```{r}
# Create the ggplot object
umap_plot2 <- ggplot(umap_long, aes(x = umap_1, y = umap_2, color = expression)) +
  geom_point() +
  facet_grid(gene ~ orig.ident) +  # Facet by gene and cell type
  scale_color_gradient(low = "lightgrey", high = "blue") +
  theme_minimal() +
  theme(text = element_text(size = 12))

# Save the plot as a PNG image with dimensions 5x5 inches
ggsave("gene_expression_umap.png", plot = umap_plot2, width = 7, height = 5, dpi = 1200)

```


```{r}
# Extract UMAP coordinates
umap_coords <- Embeddings(seurat_combined, reduction = "umap")

# Extract gene expression data and metadata
gene_data <- FetchData(seurat_combined, vars = c("ENG", "ACVRL1", "SOST", "IGFBP3", "ISLR", "orig.ident"))

# Combine UMAP coordinates with gene expression data
umap_data <- cbind(umap_coords, gene_data)

# View the first few rows of the combined data
head(umap_data)

umap_data <- umap_data %>%
  rename(CD105 = ENG)

# Reshape the data to long format
umap_long <- melt(umap_data, id.vars = c("umap_1", "umap_2", "orig.ident"), 
                  measure.vars = c("CD105", "ACVRL1", "SOST", "IGFBP3", "ISLR"),
                  variable.name = "gene", value.name = "expression")

# View the first few rows of the reshaped data
head(umap_long)

# Use ggplot to create custom plots with different colors for each gene
ggplot(umap_long, aes(x = umap_1, y = umap_2, color = expression)) +
  geom_point() +
  facet_grid(gene ~ orig.ident) +  # Facet by gene and cell type
  scale_color_gradient(low = "lightgrey", high = "blue") +
  theme_minimal() +
  ggtitle("Gene Expression on UMAP")
```


```{r}
seurat_combined <- SetIdent(seurat_combined, value = "orig.ident")

# Compare AdultCDC to CF
markers_adultcdc_vs_cf <- FindMarkers(seurat_combined, ident.1 = "AdultCDC", ident.2 = "CF")

# Compare AdultCDC to EC
markers_adultcdc_vs_ec <- FindMarkers(seurat_combined, ident.1 = "AdultCDC", ident.2 = "EC")

# Compare AdultCDC to SMC
markers_adultcdc_vs_smc <- FindMarkers(seurat_combined, ident.1 = "AdultCDC", ident.2 = "SMC")

# Compare AdultCDC to NeonatalCDC
markers_adultcdc_vs_neonatalcdc <- FindMarkers(seurat_combined, ident.1 = "AdultCDC", ident.2 = "NeonatalCDC")
markers_adultcdc_vs_neonatalcdc

all_genes <- rownames(seurat_combined)
if ("NT5E" %in% all_genes) {
    print("NT5E is present in the dataset.")
} else {
    print("NT5E is NOT present in the dataset.")
}

VlnPlot(seurat_combined, features = "NT5E", group.by = "orig.ident")

markers_adultcdc_vs_neonatalcdc_newthresh <- FindMarkers(seurat_combined, 
                                               ident.1 = "AdultCDC", 
                                               ident.2 = "NeonatalCDC", 
                                               logfc.threshold = 0, 
                                               min.pct = 0)

nt5e_results <- markers_adultcdc_vs_neonatalcdc_newthresh[rownames(markers_adultcdc_vs_neonatalcdc_newthresh) == "NT5E", ]
print(nt5e_results)


```

```{r}
# Find top expressing genes in each comparison
top_genes_adultcdc_vs_cf <- markers_adultcdc_vs_cf %>%
  arrange(desc(avg_log2FC)) %>%
  head(20)

top_genes_adultcdc_vs_ec <- markers_adultcdc_vs_ec %>%
  arrange(desc(avg_log2FC)) %>%
  head(20)

top_genes_adultcdc_vs_smc <- markers_adultcdc_vs_smc %>%
  arrange(desc(avg_log2FC)) %>%
  head(20)

top_genes_adultcdc_vs_neonatalcdc <- markers_adultcdc_vs_neonatalcdc %>%
  arrange(desc(avg_log2FC)) %>%
  head(20)

# Combine top genes from all comparisons
combined_top_genes <- bind_rows(
  top_genes_adultcdc_vs_cf %>% mutate(comparison = "AdultCDC vs CF"),
  top_genes_adultcdc_vs_ec %>% mutate(comparison = "AdultCDC vs EC"),
  top_genes_adultcdc_vs_smc %>% mutate(comparison = "AdultCDC vs SMC"),
  top_genes_adultcdc_vs_neonatalcdc %>% mutate(comparison = "AdultCDC vs NeonatalCDC")
)

# View combined results
head(combined_top_genes)

```
```{r}
# Example: Plot top genes from the AdultCDC vs CF comparison
FeaturePlot(seurat_combined, features = rownames(top_genes_adultcdc_vs_cf))
```

```{r}
# Extract logFC for CXCL6 from each comparison
logfc_values <- data.frame(
  Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
  logFC = c(
    markers_adultcdc_vs_cf["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_ec["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_smc["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_neonatalcdc["CXCL6", "avg_log2FC"]
  )
)

ggplot(logfc_values, aes(x = Comparison, y = logFC, fill = Comparison)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Log Fold Change of CXCL6 Across Comparisons",
       x = "Comparison",
       y = "Log Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Purples") +
  ylim(-1, 10)

# Extract logFC and p-values for CXCL6 from each comparison
logfc_and_pvalues <- data.frame(
  Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
  logFC = c(
    markers_adultcdc_vs_cf["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_ec["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_smc["CXCL6", "avg_log2FC"],
    markers_adultcdc_vs_neonatalcdc["CXCL6", "avg_log2FC"]
  ),
  p_value = c(
    markers_adultcdc_vs_cf["CXCL6", "p_val"],
    markers_adultcdc_vs_ec["CXCL6", "p_val"],
    markers_adultcdc_vs_smc["CXCL6", "p_val"],
    markers_adultcdc_vs_neonatalcdc["CXCL6", "p_val"]
  )
)

# Add significance stars based on p-value
logfc_and_pvalues$significance <- cut(logfc_and_pvalues$p_value,
  breaks = c(-Inf, 0.001, 0.01, 0.05, 1),
  labels = c("***", "**", "*", "ns"),
  right = FALSE
)

cxcl6 <- ggplot(logfc_and_pvalues, aes(x = Comparison, y = logFC, fill = Comparison)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = significance), vjust = -0.5, size = 5) +
  theme_minimal() +
  labs(title = "Log Fold Change of CXCL6 Across Comparisons",
       y = "Log Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Purples") +
  ylim(-1, 10)

cxcl6

```

```{r}
# List of genes to analyze
genes <- c("MMP1", "CXCL5", "NT5E", "TFP12", "LRP1", "IGFBP7")

# Create an empty list to store plots
plots <- list()

# Loop through each gene
for (gene in genes) {
  
  # Extract logFC for each gene from each comparison
  logfc_values <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "avg_log2FC"]
    )
  )
  
  # Extract logFC and p-values for each gene from each comparison
  logfc_and_pvalues <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "avg_log2FC"]
    ),
    p_value = c(
      markers_adultcdc_vs_cf[gene, "p_val"],
      markers_adultcdc_vs_ec[gene, "p_val"],
      markers_adultcdc_vs_smc[gene, "p_val"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "p_val"]
    )
  )
  
  # Add significance stars based on p-value
  logfc_and_pvalues$significance <- cut(logfc_and_pvalues$p_value,
    breaks = c(-Inf, 0.001, 0.01, 0.05, 1),
    labels = c("***", "**", "*", "ns"),
    right = FALSE
  )
  
  # Create the plot for the current gene
  plot <- ggplot(logfc_and_pvalues, aes(x = Comparison, y = logFC, fill = Comparison)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = significance), vjust = -0.5, size = 5) +
    theme_minimal() +
    labs(title = paste("Log Fold Change of", gene, "Across Comparisons"),
         x = "Comparison",
         y = "Log Fold Change") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_brewer(palette = "Purples") 
    #ylim(-2, 2)
  
  # Add the plot to the list of plots
  plots[[gene]] <- plot
}

# Display all plots
for (gene in genes) {
  print(plots[[gene]])
}

```

```{r}
# List of genes to analyze (remove CSF3, TFPI2, CXCL3, MTRNR2L12... C3, TFPI2??)
genes <- c("SOST", "CXCL8", "CXCL1", "CXCL5", "CTHRC1", "NT5E", "COL3A1", "HLA-B", "CREG1",
           "COL6A1", "C3", "MRC2", "COL5A1", "COL1A2", "LIPA", "IGFBP7", "AGRN")

# Create an empty list to store plots
plots <- list()

# Loop through each gene
for (gene in genes) {
  
  # Extract logFC for each gene from each comparison
  logfc_values <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "avg_log2FC"]
    )
  )
  
  # Extract logFC and p-values for each gene from each comparison
  logfc_and_pvalues <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "avg_log2FC"]
    ),
    p_value = c(
      markers_adultcdc_vs_cf[gene, "p_val"],
      markers_adultcdc_vs_ec[gene, "p_val"],
      markers_adultcdc_vs_smc[gene, "p_val"],
      markers_adultcdc_vs_neonatalcdc_newthresh[gene, "p_val"]
    )
  )
  
  # Add significance stars based on p-value
  logfc_and_pvalues$significance <- cut(logfc_and_pvalues$p_value,
    breaks = c(-Inf, 0.001, 0.01, 0.05, 1),
    labels = c("***", "**", "*", "ns"),
    right = FALSE
  )
  
  # Create the plot for the current gene
  plot <- ggplot(logfc_and_pvalues, aes(x = Comparison, y = logFC, fill = Comparison)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = significance), vjust = -0.9, size = 7) +
    theme_minimal() +
    labs(title = bquote(italic(.(gene))),
         x = NULL,
         y = "Log Fold Change") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
          plot.title = element_text(hjust = 0.5, face = "italic", size = 14)) +
    scale_fill_manual(values = c("AdultCDC vs CF" = "blue",
                                 "AdultCDC vs EC" = "black",
                                 "AdultCDC vs SMC" = "darkgrey",
                                 "AdultCDC vs NeonatalCDC" = "lightgrey")) +
    ylim(-2, 13)
  
  # Add the plot to the list of plots
  plots[[gene]] <- plot
  
  # Save the plot with dimensions of 5 x 5 inches
  ggsave(filename = paste0(gene, "_logFC_plot.png"), plot = plot, width = 5, height = 5)
}

# Display all plots
for (gene in genes) {
  print(plots[[gene]])
}

```


```{r}
# Fetch expression data for NT5E
ISLR_expression <- FetchData(seurat_combined, vars = "ISLR")

# Add the cell type labels (assuming your cell types are stored in the "cell_type" metadata)
ISLR_data <- data.frame(CellType = seurat_combined@meta.data$orig.ident, ISLR = ISLR_expression)

# Boxplot of NT5E expression by cell type
ggplot(ISLR_data, aes(x = CellType, y = ISLR)) +
  geom_boxplot() +
  labs(title = "Expression of ISLR by Cell Type", y = "ISLR Expression") +
  theme_minimal()

# Check how many cells express NT5E (non-zero counts)
ISLR_non_zero <- ISLR_data %>%
  filter(ISLR > 0) %>%
  group_by(CellType) %>%
  summarise(count = n())

print(ISLR_non_zero)

# Summarize expression data by cell type
summary_data <- ISLR_data %>%
  group_by(CellType) %>%
  summarise(mean_expression = mean(ISLR, na.rm = TRUE),
            num_cells = n())

print(summary_data)

```



```{r}
# Extract expression data for the genes of interest
expression_data <- FetchData(seurat_combined, vars = c("NT5E", "CXCL6", "CTHRC1", "COL3A1", "HLAB", "CREG1", "COL6A1", "MRC2", "CTHRC1", "COL5A1", "TFP12", "LRP1", "IGFBP7", "ICAM2", "CDH5", "VWF"))

# Compute the correlation matrix
correlation_matrix <- cor(expression_data, use = "pairwise.complete.obs")

# Print the correlation matrix
print(correlation_matrix)

# Convert correlation matrix to long format for ggplot
correlation_melted <- melt(correlation_matrix)

# heat map correlation heatmap
ggplot(correlation_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "CDH5" = "CDH5"))  +
  scale_y_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "CDH5" = "CDH5")) +
  geom_text(aes(label = round(value, 2)), color = "black", size = 3)

```

```{r}
# Extract expression data for the genes of interest
expression_data <- FetchData(seurat_combined, vars = c("NT5E", "CXCL6", "CTHRC1", "COL3A1", "HLAB", "CREG1", "COL6A1", "MRC2", "CTHRC1", "COL5A1", "TFP12", "LRP1", "IGFBP7", "CXCL5", "THY1", "GATA4"))

expression_data <- FetchData(seurat_combined, vars = c("NARS1",
"ISLR",
"COL12A1",
"FBLN2",
"CCN2",
"MGP",
"SOST",
"CD14",
"SOD2",
"PTGDS",
"COL1A1",
"CAPZA1",
"THBS1",
 "CXCL6", "CXCL5", "THY1", "GATA4",
"ICAM2", "CDH5", "VWF",
"VIM", "FN1", "POSTN"))

expression_data <- FetchData(seurat_combined, vars = c("RPL22",
"FAH",
"PPP1R14B",
"RPL27A",
"HNRNPH1",
"AHNAK",
"RAB11B",
"ARCN1",
"GLO1",
"B4GAT1",
 "CXCL6", "CXCL5", "THY1", "GATA4",
"ICAM2", "CDH5", "VWF",
"VIM", "FN1", "POSTN"))


# Compute the correlation matrix
correlation_matrix <- cor(expression_data, use = "pairwise.complete.obs")

# Print the correlation matrix
print(correlation_matrix)

# Convert correlation matrix to long format for ggplot
correlation_melted <- melt(correlation_matrix)

# heat map correlation heatmap
ggplot(correlation_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "pink", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "THY1" = "CD90"))  +
  scale_y_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "THY1" = "CD90")) +
  geom_text(aes(label = round(value, 2)), color = "black", size = 2)


```


```{r}
# Extract expression data for the genes of interest
expression_data <- FetchData(seurat_combined, vars = c("SOST", "ISLR", "IGFBP3", "ACVRL1", "ENG", "TGFBR2", "ICAM2", "CDH5", "VWF"))

# Compute the correlation matrix
correlation_matrix <- cor(expression_data, use = "pairwise.complete.obs")

# Print the correlation matrix
print(correlation_matrix)

# Convert correlation matrix to long format for ggplot
correlation_melted <- melt(correlation_matrix)

# heat map correlation heatmap
ggplot(correlation_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "green", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "CDH5" = "CDH5"))  +
  scale_y_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "CDH5" = "CDH5")) +
  geom_text(aes(label = round(value, 2)), color = "black", size = 3)
```


```{r}
# Extract expression data for the genes of interest
expression_data <- FetchData(seurat_combined, vars = c("SOST", "ISLR", "IGFBP3", "ACVRL1", "ENG", "TGFBR2", "CXCL6", "CXCL5", "CD90"))

# Compute the correlation matrix
correlation_matrix <- cor(expression_data, use = "pairwise.complete.obs")

# Print the correlation matrix
print(correlation_matrix)

# Convert correlation matrix to long format for ggplot
correlation_melted <- melt(correlation_matrix)

# heat map correlation heatmap
ggplot(correlation_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "green", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "THY1" = "CD90"))  +
  scale_y_discrete(labels = c("ACVRL1" = "ACVRL1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "THY1" = "CD90")) +
  geom_text(aes(label = round(value, 2)), color = "black", size = 3)

```


```{r}
# Co-Expression
# Plot the expression of ACVRL1, CXCL6, ENG, and CD73
FeaturePlot(seurat_combined, features = c("CXCL6", "CTHRC1", "NT5E", "ENG"), ncol = 2) +
  scale_x_discrete(labels = c("CXCL6" = "CXCL6", "NT5E" = "CD73"))

# Create a DotPlot for the genes of interest
DotPlot(seurat_combined, features = c("CXCL6", "NT5E", "CTHRC1"), group.by = "orig.ident") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("CXCL6" = "CXCL6", "NT5E" = "CD73"))

# Create a DotPlot for the genes of interest
DotPlot(seurat_combined, 
        features = c("CTHRC1", "CXCL6", "NT5E", "ENG", "COL3A1", "AKR1C3", "HIST1H1A", "HLA-B"), 
        group.by = "orig.ident") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_x_discrete(
          labels = c("CTHRC1" = "CTHRC1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73")
          )
```


# Secretome factors hHiPC
```{r}
secdf <- read.csv("Secretome_List_NT.csv")
```

```{r}
# Extract gene names from the specified column
Gene <- secdf$Gene.Names # Replace 'gene' with the correct column name if different

secfiltered_df <- as.data.frame(Gene)

```

# Threshold only CDC genes
```{r}
# Calculate average expression levels by cluster
avg_expression <- AggregateExpression(seurat_combined, group.by = "orig.ident")

# Extract average expression data
avg_expression_data <- avg_expression$RNA  # Assuming the data is stored in the 'RNA' assay

# Check if SOST is present in the rownames
if ("ISLR" %in% rownames(avg_expression_data)) {
  # Get the average expression of SOST in each cluster
  sost_expression_avg <- avg_expression_data["ISLR", ]
  
  # Display the average expression levels
  print(sost_expression_avg)
} else {
  cat("SOST gene is not found in the average expression data.\n")
}


```

```{r}
# Fetch expression data for SOST across all cells
sost_data <- FetchData(seurat_combined, vars = "ISLR")

# Add the orig.ident (cell type) as a metadata column
sost_data$orig.ident <- seurat_combined$orig.ident

# Calculate average expression for SOST by cluster
sost_avg_by_cluster <- aggregate(sost_data$ISLR, by = list(sost_data$orig.ident), FUN = mean)

# Rename the columns for clarity
colnames(sost_avg_by_cluster) <- c("Cluster", "Avg_SOST_Expression")

# Display the average expression levels
print(sost_avg_by_cluster)

```


# Which genes following SOST expression profile?
```{r}
# Step 1: Calculate average expression levels by cluster
avg_expression <- AggregateExpression(seurat_combined, group.by = "orig.ident")

# Extract average expression data
avg_expression_data <- avg_expression$RNA  # Assuming the data is stored in the 'RNA' assay

# Check the row names (genes)
gene_names <- rownames(avg_expression_data)
print(gene_names[1:5])  # Display the first 5 gene names for a quick check

# Check the column names (cell types)
cell_types <- colnames(avg_expression_data)
print(cell_types)  # Display all column names to verify the cell types


# Define thresholds
threshold <- 0.009833558      # Set the threshold for expression in AdultCDC and NeonatalCDC
low_threshold <- 0.009833558 # Set the low threshold for expression in EC, SMC, and CF

# Filter genes based on expression levels
selected_genes_onlycdc <- gene_names[
  avg_expression_data[,"AdultCDC"] > threshold &
  avg_expression_data[,"NeonatalCDC"] > threshold &
  avg_expression_data[,"EC"] <= low_threshold &
  avg_expression_data[,"SMC"] <= low_threshold &
  avg_expression_data[,"CF"] <= low_threshold
]


# View selected genes
str(selected_genes_onlycdc)

# Convert selected genes to a data frame
selected_genes_df_onlycdc <- data.frame(Gene = selected_genes_onlycdc)

# Specify the file path where you want to save the CSV
file_path <- "selected_genes_onlycdc.csv"  # Change the path if needed
```

# Find the common genes
```{r}
# Remove leading/trailing whitespace and convert to uppercase
selected_genes_df_onlycdc$Gene <- trimws(toupper(selected_genes_df_onlycdc$Gene))
secfiltered_df$Gene <- trimws(toupper(secfiltered_df$Gene))

# Assuming both data frames have a column named 'Gene'
common_genes_df <- merge(selected_genes_df_onlycdc, secfiltered_df, by = "Gene")

# View the new data frame with common genes
print(common_genes_df)

```


```{r}
# Convert the Gene column in common_genes_df to a character vector
features <- as.character(common_genes_df$Gene)

# Create a violin plot for the common genes in the Seurat object
VlnPlot(seurat_combined, features = features)

```

# Now add BMP9 secretome
# Secretome factors hHiPC
```{r}
secdf <- read.csv("Secretome_List_B9add.csv")
```

```{r}
# Extract gene names from the specified column
Gene <- secdf$Gene.Names # Replace 'gene' with the correct column name if different

secfiltered_df <- as.data.frame(Gene)

```

# Threshold only CDC genes
```{r}
# Calculate average expression levels by cluster
avg_expression <- AggregateExpression(seurat_combined, group.by = "orig.ident")

# Extract average expression data
avg_expression_data <- avg_expression$RNA  # Assuming the data is stored in the 'RNA' assay

# Check if SOST is present in the rownames
if ("SOST" %in% rownames(avg_expression_data)) {
  # Get the average expression of SOST in each cluster
  sost_expression_avg <- avg_expression_data["SOST", ]
  
  # Display the average expression levels
  print(sost_expression_avg)
} else {
  cat("SOST gene is not found in the average expression data.\n")
}


```

```{r}
# Fetch expression data for SOST across all cells
sost_data <- FetchData(seurat_combined, vars = "SOST")

# Add the orig.ident (cell type) as a metadata column
sost_data$orig.ident <- seurat_combined$orig.ident

# Calculate average expression for SOST by cluster
sost_avg_by_cluster <- aggregate(sost_data$SOST, by = list(sost_data$orig.ident), FUN = mean)

# Rename the columns for clarity
colnames(sost_avg_by_cluster) <- c("Cluster", "Avg_SOST_Expression")

# Display the average expression levels
print(sost_avg_by_cluster)

```


# Which genes following SOST expression profile?
```{r}
# Step 1: Calculate average expression levels by cluster
avg_expression <- AggregateExpression(seurat_combined, group.by = "orig.ident")

# Extract average expression data
avg_expression_data <- avg_expression$RNA  # Assuming the data is stored in the 'RNA' assay

# Check the row names (genes)
gene_names <- rownames(avg_expression_data)
print(gene_names[1:5])  # Display the first 5 gene names for a quick check

# Check the column names (cell types)
cell_types <- colnames(avg_expression_data)
print(cell_types)  # Display all column names to verify the cell types


# Define thresholds
threshold <- 0.009833558      # Set the threshold for expression in AdultCDC and NeonatalCDC
low_threshold <- 0.009833558 # Set the low threshold for expression in EC, SMC, and CF

# Filter genes based on expression levels
selected_genes_onlycdc <- gene_names[
  avg_expression_data[,"AdultCDC"] > threshold &
  avg_expression_data[,"NeonatalCDC"] > threshold &
  avg_expression_data[,"EC"] <= low_threshold &
  avg_expression_data[,"SMC"] <= low_threshold &
  avg_expression_data[,"CF"] <= low_threshold
]


# View selected genes
str(selected_genes_onlycdc)

# Convert selected genes to a data frame
selected_genes_df_onlycdc <- data.frame(Gene = selected_genes_onlycdc)

# Specify the file path where you want to save the CSV
file_path <- "selected_genes_onlycdc.csv"  # Change the path if needed
```

# Find the common genes
```{r}
# Remove leading/trailing whitespace and convert to uppercase
selected_genes_df_onlycdc$Gene <- trimws(toupper(selected_genes_df_onlycdc$Gene))
secfiltered_df$Gene <- trimws(toupper(secfiltered_df$Gene))

# Assuming both data frames have a column named 'Gene'
common_genes_df <- merge(selected_genes_df_onlycdc, secfiltered_df, by = "Gene")

# View the new data frame with common genes
print(common_genes_df)

```


```{r}
# Convert the Gene column in common_genes_df to a character vector
features <- as.character(common_genes_df$Gene)

# Create a violin plot for the common genes in the Seurat object
VlnPlot(seurat_combined, features = features)

```


```{r}
# Specify the file path where you want to save the CSV
output_file_path <- "C:/Users/micha/OneDrive/Documents/SingleCell_CSphere/CSPhere/secfiltered_df.csv"

# Save the data frame as a CSV
write.csv(secfiltered_df, file = output_file_path, row.names = FALSE)
```

# all violins
```{r}
# Trim whitespace from gene names
secfiltered_genes_clean <- trimws(secfiltered_genes)
rownames_seurat_clean <- trimws(rownames(seurat_combined))

# Filter valid genes
valid_genes <- secfiltered_genes_clean[secfiltered_genes_clean %in% rownames_seurat_clean]

# Generate and display a violin plot for each gene in valid_genes
for (gene in valid_genes) {
  plot <- VlnPlot(seurat_combined, features = gene, pt.size = 0.5)
  print(plot)
}

```





```{r}
features <- c("NRDC", "BMP10", "TGFBR2")
featuresbmp <- c("GDF2", "ACVRL1", "ISLR")
featuresbmp2 <- c("SOST", "IGFBP3", "ISLR")
featureserbb <- c("EGFR", "ERBB2", "ERBB4")
featuresEC <- c("CDH5", "VWF", "PECAM1")
featurescxc <- c("CXCL6", "ENG", "ACVRL1")
featuresfibro <- c("IGFBP2", "INMT", "SBSPON")
featuressmc <- c("ACTA2", "CALD1", "TAGLN")
featurescalc <- c("SOST", "LRP5", "LRP6")

VlnPlot(seurat_combined, features = features) 
VlnPlot(seurat_combined, features = featuresbmp)
VlnPlot(seurat_combined, features = featuresbmp2)
VlnPlot(seurat_combined, features = featureserbb)
VlnPlot(seurat_combined, features = featurescxc)
VlnPlot(seurat_combined, features = featuresfibro)
VlnPlot(seurat_combined, features = featuresEC)
VlnPlot(seurat_combined, features = featuressmc)
VlnPlot(seurat_combined, features = featurescalc)
```

```{r}
# Define the features for plotting
featurescalc <- c("EGF", "EGFR", "ERBB2")
featurescalc2 <- c("IGFBP3", "LRP1", "IGF1R")
featurescalc3 <- c("GDF2", "ACVRL1", "ENG")

# Subset the Seurat object to include only the desired cell types (CF, NeonatalCDC, AdultCDC)
# Assuming you have a "celltype" metadata column
seurat_subset <- subset(seurat_combined, idents = c("EC", "AdultCDC"))

# Create violin plots for the specified genes for the selected cell types
VlnPlot(seurat_subset, features = featurescalc)
VlnPlot(seurat_subset, features = featurescalc2)
VlnPlot(seurat_subset, features = featurescalc3)

```

```{r}
# Define cell types for cardiosphere and negative control
cell_types <- c("adultcdc", "neonatalcdc")

# Subset the Seurat object to include only cells from the cardiosphere and negative control
seurat_subset <- subset(seurat_combined, idents = )

# Get the expression data
expression_data <- GetAssayData(seurat_subset, assay = "RNA", slot = "data")  # Use "counts" or "data" based on what you're interested in

# Calculate the average expression for each gene across the cells in the subset
gene_expression_average <- rowMeans(expression_data)

# Define a threshold to consider a gene as 'not expressed'
# For example, you can set genes with average expression <= 0.1 (log-transformed expression) as not expressed
threshold <- 0.1
genes_not_expressed <- names(gene_expression_average[gene_expression_average <= threshold])

# View the genes that are not expressed
genes_not_expressed

```


```{r}
# Access metadata from the Seurat object
metadata <- seurat_combined@meta.data

# Count the number of cells per orig.ident
cell_counts <- table(metadata$orig.ident)

# Display the result
print(cell_counts)
```


```{r}
# List of genes to analyze
genes2 <- c("SOST", "ISLR")

# Create an empty list to store plots
plots <- list()

# Loop through each gene
for (gene in genes2) {
  
  # Extract logFC for each gene from each comparison
  logfc_values <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc[gene, "avg_log2FC"]
    )
  )
  
  # Extract logFC and p-values for each gene from each comparison
  logfc_and_pvalues <- data.frame(
    Comparison = c("AdultCDC vs CF", "AdultCDC vs EC", "AdultCDC vs SMC", "AdultCDC vs NeonatalCDC"),
    logFC = c(
      markers_adultcdc_vs_cf[gene, "avg_log2FC"],
      markers_adultcdc_vs_ec[gene, "avg_log2FC"],
      markers_adultcdc_vs_smc[gene, "avg_log2FC"],
      markers_adultcdc_vs_neonatalcdc[gene, "avg_log2FC"]
    ),
    p_value = c(
      markers_adultcdc_vs_cf[gene, "p_val"],
      markers_adultcdc_vs_ec[gene, "p_val"],
      markers_adultcdc_vs_smc[gene, "p_val"],
      markers_adultcdc_vs_neonatalcdc[gene, "p_val"]
    )
  )
  
  # Add significance stars based on p-value
  logfc_and_pvalues$significance <- cut(logfc_and_pvalues$p_value,
    breaks = c(-Inf, 0.001, 0.01, 0.05, 1),
    labels = c("***", "**", "*", "ns"),
    right = FALSE
  )
  
  # Create the plot for the current gene
  plot <- ggplot(logfc_and_pvalues, aes(x = Comparison, y = logFC, fill = Comparison)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = significance), vjust = -0.5, size = 5) +
    theme_minimal() +
    labs(title = paste("Log Fold Change of", gene, "Across Comparisons"),
         x = "Comparison",
         y = "Log Fold Change") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_brewer(palette = "Purples") 
  
  # Add the plot to the list of plots
  plots[[gene]] <- plot
}

# Display all plots
for (gene in genes2) {
  print(plots[[gene]])
}
```

```{r}
# Create a DotPlot for the genes of interest
DotPlot(seurat_combined, 
        features = c("CXCL6", "NT5E", "CTHRC1", "ACVRL1"), 
        group.by = "orig.ident") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_x_discrete(
          labels = c("CTHRC1" = "CTHRC1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73", "ACVRL1" = "ALK1")
          )
```



```{r}
# Create a DotPlot for the genes of interest
exp <- DotPlot(seurat_combined, 
        features = c("ENG", "ACVRL1", "ISLR", "IGFBP3", "SOST", "GDF2"), 
        group.by = "orig.ident") +
        theme(
          axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  # Adjust x-axis text size
          axis.text.y = element_text(size = 12),  # Adjust y-axis text size
          plot.title = element_text(size = 12),  # Adjust title size
          legend.text = element_text(size = 12),  # Adjust legend text size
          legend.title = element_text(size = 12)   # Adjust legend title size
        ) +
        scale_x_discrete(
          labels = c("CTHRC1" = "CTHRC1", "CXCL6" = "CXCL6", "ENG" = "CD105", "NT5E" = "CD73")
        ) 
        #scale_color_gradient(low = "#1B9E77", high = "#E7298A")

#ggsave("dotplot.png", plot = exp, dpi = 1200, width = 10, height = 8)
exp

```


```{r}
FeaturePlot(seurat_combined, features = c("SOST", "ISLR"), blend = TRUE)

# Blended feature plot
p1 <- FeaturePlot(seurat_combined, features = c("SOST", "ISLR"), blend = TRUE)

# DimPlot for orig.ident with cluster labels
p2 <- DimPlot(seurat_combined, group.by = "orig.ident", label = TRUE, repel = TRUE)

# Combine FeaturePlot and DimPlot side by side

p2
```





```{r}
FeaturePlot(seurat_combined, features = c("NRDC", "THBS2"), blend = TRUE)

# Blended feature plot
p1 <- FeaturePlot(seurat_combined, features = c("NRDC", "THBS2"), blend = TRUE)

# DimPlot for orig.ident with cluster labels
p2 <- DimPlot(seurat_combined, group.by = "orig.ident", label = TRUE, repel = TRUE)

p2
p1

# Save the plot with sufficient width and height
ggsave("feature_plot.png", plot = p1, width = 10, height = 3, dpi = 600)

```


```{r}
expression_data <- GetAssayData(seurat_combined, assay = "RNA", features = c("ISLR"), slot = "data")

# 2. Convert sparse matrix to a dense matrix (data frame)
expression_data_dense <- as.data.frame(as.matrix(expression_data))

# Transpose if you need ISLR as a column
expression_data_dense <- t(expression_data_dense)

# Ensure ISLR is now a column
"ISLR" %in% colnames(expression_data_dense)  

# 3. Calculate the correlation matrix for the gene expression data (use dense matrix)
correlation_matrix <- cor(expression_data_dense, use = "pairwise.complete.obs")

# 3. Extract the correlation values for the gene "ISLR" (ensure ISLR is present)
if ("ISLR" %in% colnames(correlation_matrix)) {
  islr_correlation <- correlation_matrix["ISLR", ]  # Get correlations for ISLR
  
  # 4. Convert to data frame
  islr_correlation_df <- data.frame(
    Gene = names(islr_correlation),
    Correlation = islr_correlation
  )
  
  # 5. Filter only positive correlations and sort by correlation strength
  positive_islr_correlation_df <- islr_correlation_df[islr_correlation_df$Correlation > 0, ]
  positive_islr_correlation_df <- positive_islr_correlation_df[order(positive_islr_correlation_df$Correlation, decreasing = TRUE), ]
  
  # 6. Get the top 20 genes with the highest positive correlations
  top_20_positively_correlated_genes <- head(positive_islr_correlation_df, 20)
  
  # 7. View the top 20 genes
  print(top_20_positively_correlated_genes)
} else {
  print("Gene ISLR not found in the dataset.")
}

#write.csv(top_20_positively_correlated_genes, file = "top_20_positively_correlated_genes.csv", row.names = FALSE)

#write.csv(positive_islr_correlation_df, file = "positive_islr_correlation_df.csv", row.names = FALSE)

```

```{r}
#FIND EXCLUSIVE GENES to NEONATAL CDC
# Define thresholds
min_cells <- 100       # Minimum number of cells expressing the gene
min_expression <- 5    # Minimum average expression level across expressing cells

# Genes in neoCDC_cells
expressed_in_neonatal_high <- rownames(GetAssayData(neoCDC_cells, slot = "counts")[
  (Matrix::rowSums(GetAssayData(neoCDC_cells, slot = "counts") > 0) >= min_cells) & 
  (Matrix::rowMeans(GetAssayData(neoCDC_cells, slot = "counts")) >= min_expression), ])

# Genes in seurat_combined, excluding NeonatalCDC
expressed_elsewhere_high <- rownames(GetAssayData(seurat_combined, slot = "counts")[
  (Matrix::rowSums(GetAssayData(seurat_combined, slot = "counts")[, seurat_combined$orig.ident != "NeonatalCDC"] < 0) <= min_cells) & 
  (Matrix::rowMeans(GetAssayData(seurat_combined, slot = "counts")[, seurat_combined$orig.ident != "NeonatalCDC"]) <= min_expression), ])

# Genes expressed in at least 100 cells in neoCDC_cells
expressed_in_neonatal_100 <- rownames(GetAssayData(neoCDC_cells, slot = "counts")[Matrix::rowSums(GetAssayData(neoCDC_cells, slot = "counts") > 0) >= 100, ])

# Genes expressed in at least 100 cells elsewhere
expressed_elsewhere_100 <- rownames(GetAssayData(seurat_combined, slot = "counts")[Matrix::rowSums(GetAssayData(seurat_combined, slot = "counts")[, seurat_combined$orig.ident != "NeonatalCDC"] > 0) <= 100, ])

# 1. Extract expressed genes in neoCDC_cells
expressed_in_neonatal <- rownames(GetAssayData(neoCDC_cells, slot = "counts")[Matrix::rowSums(GetAssayData(neoCDC_cells, slot = "counts") > 0) > 0, ])

# 2. Extract all genes expressed in the rest of the dataset
expressed_elsewhere <- rownames(GetAssayData(seurat_combined, slot = "counts")[Matrix::rowSums(GetAssayData(seurat_combined, slot = "counts")[, seurat_combined$orig.ident != "NeonatalCDC"] > 0) > 0, ])

# 3. Find exclusive genes
exclusive_genes_neo <- setdiff(expressed_in_neonatal, expressed_elsewhere)
exclusive_genes_neo_100 <- setdiff(expressed_in_neonatal_100, expressed_elsewhere_100)
exclusive_genes_neo_high <- setdiff(expressed_in_neonatal_high, expressed_elsewhere_high)

exclusive_genes_df <- as.data.frame(exclusive_genes)
exclusive_genes_neo_100 <- as.data.frame(exclusive_genes_neo_100)
exclusive_genes_neo_high <- as.data.frame(exclusive_genes_neo_high)

# Optionally, store or visualize these genes
write.csv(exclusive_genes_neo_100, "exclusive_genes_NeonatalCDC_100.csv")

```



```{r}
# 1. Subset Seurat object to include only adultCDC cells
# Assuming 'seurat_combined' has metadata that indicates cell type in a column, e.g., 'cell_type'
neoCDC_cells <- subset(seurat_combined, subset = orig.ident == "NeonatalCDC")

# 2. Extract expression data for the 'ISLR' gene in the adultCDC group
expression_data <- GetAssayData(neoCDC_cells, assay = "RNA", features = c("ISLR"), slot = "data")

# 3. Convert sparse matrix to a dense matrix (data frame)
expression_data_dense <- as.data.frame(as.matrix(expression_data))

# 4. Transpose if needed so that ISLR is a column
expression_data_dense <- t(expression_data_dense)

# 5. Ensure ISLR is now a column
if ("ISLR" %in% colnames(expression_data_dense)) {

  # 6. Compute the correlation matrix for adultCDC cells
  correlation_matrix <- cor(expression_data_dense, use = "pairwise.complete.obs")

  # 7. Extract the correlation values for ISLR
  islr_correlation <- correlation_matrix["ISLR", ]  # Get correlations for ISLR
  
  # 8. Convert to a data frame
  islr_correlation_df <- data.frame(
    Gene = names(islr_correlation),
    Correlation = islr_correlation
  )
  
  # 9. Filter only positive correlations and sort by correlation strength
  positive_islr_correlation_df <- islr_correlation_df[islr_correlation_df$Correlation > 0, ]
  positive_islr_correlation_df <- positive_islr_correlation_df[order(positive_islr_correlation_df$Correlation, decreasing = TRUE), ]
  
  # 10. Get the top 20 genes with the highest positive correlations
  top_20_positively_correlated_genes <- head(positive_islr_correlation_df, 20)
  
  # 11. View the top 20 genes
  print(top_20_positively_correlated_genes)
  
} else {
  print("Gene ISLR not found in the adultCDC subset.")
}

write.csv(top_20_positively_correlated_genes, file = "neocdc_top_20_positively_correlated_genes.csv", row.names = FALSE)

write.csv(positive_islr_correlation_df, file = "neocdc_positive_islr_correlation_df.csv", row.names = FALSE)

```



```{r}
# Assuming 'seurat_combined' has metadata that indicates cell type in a column, e.g., 'cell_type'
smc_cells <- subset(seurat_combined, subset = orig.ident == "SMC")

# Ensure ISLR is in the dataset
if (!"ISLR" %in% rownames(smc_cells)) {
  stop("ISLR is not in the dataset.")
}

# Create a binary matrix: 1 if gene is expressed, 0 otherwise
binary_expression <- GetAssayData(smc_cells, assay = "RNA", slot = "data") > 0

# Select cells where ISLR is expressed
islr_cells <- binary_expression["ISLR", ]

# Count co-expression for each gene
coexpression_counts <- rowSums(binary_expression[, islr_cells > 0])

# Remove ISLR itself from the results
coexpression_counts <- coexpression_counts[rownames(binary_expression) != "ISLR"]
islr_co <- as.data.frame(coexpression_counts)

# Identify the top co-expressed gene
top_gene <- names(which.max(coexpression_counts))

# Display the top co-expressed gene and its count
list(
  top_gene = top_gene,
  coexpression_count = max(coexpression_counts)
)

# Optionally, store or visualize these genes
write.csv(islr_co, "islr_co_smc.csv")

```



```{r}
FeaturePlot(seurat_combined, features = c("NOC2L", "ISLR"), blend = TRUE)

# Blended feature plot
p11 <- FeaturePlot(seurat_combined, features = c("NOC2L", "ISLR"), blend = TRUE) +
  theme(legend.position = "bottom") +  # Move legend to the bottom
  guides(color = guide_legend(title = "Your Legend Title", title.theme = element_text(size = 8))) +  # Adjust title size
  theme(legend.text = element_text(size = 8)) 

p11

# Save the plot with sufficient width and height
ggsave("feature_plot14.png", plot = p11, width = 10, height = 3, dpi = 600)
```

```{r}
# Extract expression data for the features
blend_data <- FetchData(seurat_combined, vars = c("ISLR", "NRG1"))

# Calculate a co-expression score for sorting
blend_data$coexpression_score <- blend_data$ISLR + blend_data$NRG1

# Add this co-expression score as a metadata column for plotting
seurat_combined$coexpression_score <- blend_data$coexpression_score

# Create the blended plot with sorted cells (co-expression highlighted)
p11 <- FeaturePlot(
  seurat_combined,
  features = c("ISLR", "NRG1"),, 
  min.cutoff = 0.1, 
  max.cutoff = 2,
  blend = TRUE,
  order = TRUE  # Ensures cells with higher values are plotted on top
) +
  theme(legend.position = "bottom") +  # Adjust legend position
  guides(
    color = guide_legend(
      title = "Expression",
      title.theme = element_text(size = 8)
    )
  ) + 
  theme(legend.text = element_text(size = 8))

p11
# Save the plot
ggsave("feature_plot14.png", plot = p11, width = 10, height = 3, dpi = 600)

```

```{r}
summary(FetchData(seurat_combined, vars = "ERBB2"))
```


```{r}
# Subset counts matrix for NeonatalCDC group
neonatal_counts <- GetAssayData(seurat_combined, slot = "counts")[, seurat_combined$orig.ident == "NeonatalCDC"]

# Calculate average expression for each gene in NeonatalCDC
average_expression <- Matrix::rowMeans(neonatal_counts)

avg_expression_df_neo <- as.data.frame(average_expression)

# Rank genes based on average expression
top_genes <- sort(average_expression, decreasing = TRUE)

# Extract the top N genes (e.g., top 10)
top_10_genes <- head(names(top_genes), 10)

# View top genes and their average expression levels
top_10_genes_and_values <- top_genes[top_10_genes]
top_10_genes_and_values

```


```{r}
# Fetch expression data
expression_data <- FetchData(seurat_combined, vars = c("CXCL6", "NT5E"))

# Set a threshold for expression (you can adjust this based on your dataset)
threshold <- 0.08  # For example, count cells expressing more than 0

# Identify co-expressing cells
co_expressed_cells <- sum(expression_data$CXCL6 > threshold & expression_data$NT5E > threshold)

# Output the count
print(co_expressed_cells)

```


```{r}
# Extract the expression data (use "counts" or "data" depending on your needs)
expression_data <- GetAssayData(seurat_combined, assay = "RNA", layer = "data")  # or "counts"

# Calculate the average expression for the whole dataset
average_expression <- mean(expression_data)

# Output the result
cat("Average expression for the entire dataset:", average_expression, "\n")

```

```{r}
# 1. Subset Seurat object for the 'NeonatalCDC' cell type
neonatalCDC_cells <- subset(seurat_combined, idents = "NeonatalCDC")

# 2. Get the expression data for all genes (default assay is 'RNA')
expression_data_neonatalCDC <- GetAssayData(neonatalCDC_cells, assay = "RNA", slot = "data")

# 3. Calculate the average expression for each gene across the 'NeonatalCDC' cells
average_expression_neonatalCDC <- mean(expression_data_neonatalCDC)

# 4. Output the average expression for all genes in the 'NeonatalCDC' cell type
cat("Average expression in NeonatalCDC for all genes:", average_expression_neonatalCDC, "\n")


```


```{r}
FeaturePlot(seurat_combined, features = c("LRP5", "LRP6"), blend = TRUE)

# Blended feature plot
p111 <- FeaturePlot(seurat_combined, features = c("LRP5", "LRP6"), blend = TRUE)

p111

# Save the plot with sufficient width and height
ggsave("feature_plotSOST.png", plot = p111, width = 10, height = 3, dpi = 600)
```



```{r}
# Add row names as a column called "Gene"
markers_adultcdc_vs_neonatalcdc_save <- rownames_to_column(markers_adultcdc_vs_neonatalcdc, var = "Gene")


# Save the data frame as an Excel file
write_xlsx(markers_adultcdc_vs_neonatalcdc_save, "markers_adultcdc_vs_neonatalcdc.xlsx")

```

```{r}
save.image(file = "my_environment.RData")
```

```{r}
sessionInfo()
```

